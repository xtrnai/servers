name: Validate Server Submission

on:
  push:
    branches:
      - main
    paths:
      - 'servers/**'
  pull_request:
    paths:
      - 'servers/**'
  workflow_dispatch:

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1

      - name: Setup jq
        uses: dcarbone/install-jq-action@v2

      - name: Detect changed servers
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            servers:
              - 'servers/**'

      - name: Validate server structure
        if: steps.filter.outputs.servers == 'true'
        run: |
          for server_dir in servers/*/; do
            if [ -d "$server_dir" ]; then
              for version_dir in "$server_dir"/*/; do
                if [ -d "$version_dir" ]; then
                  echo "Validating $version_dir"
                  
                  # Check index.ts exists
                  if [ ! -f "$version_dir/index.ts" ]; then
                    echo "ERROR: index.ts not found in $version_dir"
                    exit 1
                  fi
                  
                  # Check package.json exists and has required fields
                  if [ ! -f "$version_dir/package.json" ]; then
                    echo "ERROR: package.json not found in $version_dir"
                    exit 1
                  fi
                  
                  # Build and link xtrnlib
                  cd xtrnlib && bun install && bun run build && bun link && cd ..
                  cd "$version_dir" && bun install && bun link xtrn-server
                  
                  # Bundle with esbuild for Cloudflare Workers (virtual entry re-exports XTRNState DO)
                  echo "Building bundle with esbuild..."
                  echo 'export { XTRNState } from "xtrn-server"; export { default } from "./index.ts";' > _cf_entry.ts
                  bunx esbuild _cf_entry.ts \
                    --bundle \
                    --format=esm \
                    --platform=neutral \
                    --target=es2020 \
                    --outfile=dist/worker.mjs \
                    --external:cloudflare:workers \
                    --external:assert \
                    --external:buffer \
                    --external:child_process \
                    --external:crypto \
                    --external:events \
                    --external:fs \
                    --external:http \
                    --external:http2 \
                    --external:https \
                    --external:net \
                    --external:os \
                    --external:path \
                    --external:process \
                    --external:querystring \
                    --external:stream \
                    --external:tls \
                    --external:tty \
                    --external:url \
                    --external:util \
                    --external:zlib \
                    --external:node:assert \
                    --external:node:buffer \
                    --external:node:child_process \
                    --external:node:crypto \
                    --external:node:events \
                    --external:node:fs \
                    --external:node:http \
                    --external:node:http2 \
                    --external:node:https \
                    --external:node:net \
                    --external:node:os \
                    --external:node:path \
                    --external:node:process \
                    --external:node:querystring \
                    --external:node:stream \
                    --external:node:tls \
                    --external:node:tty \
                    --external:node:url \
                    --external:node:util \
                    --external:node:zlib || exit 1
                  rm -f _cf_entry.ts
                  
                  # Smoke test with Miniflare
                  echo "Running Miniflare smoke test..."
                  bun run --eval 'import { Miniflare } from "miniflare"; import { readFileSync } from "fs"; const mf = new Miniflare({ modules: true, script: readFileSync("./dist/worker.mjs", "utf-8"), compatibilityDate: "2025-01-01", compatibilityFlags: ["nodejs_compat"], durableObjects: { XTRN_STATE: "XTRNState" } }); try { const response = await mf.dispatchFetch("http://localhost/details"); const data = await response.json(); if (!data.name || !data.version) { console.error("ERROR: /details response missing name or version fields"); console.error("Response:", data); process.exit(1); } console.log("âœ“ Smoke test passed:", data.name, data.version); process.exit(0); } catch (error) { console.error("ERROR: Smoke test failed:", error.message); process.exit(1); } finally { await mf.dispose(); }' || exit 1
                  
                  cd ../..
                fi
              done
            fi
          done
          
          echo "All validations passed!"