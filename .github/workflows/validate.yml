name: Validate Server Submission

on:
  push:
    branches:
      - main
    paths:
      - 'servers/**'
  pull_request:
    paths:
      - 'servers/**'
  workflow_dispatch:

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1

      - name: Setup jq
        uses: dcarbone/install-jq-action@v2

      - name: Detect changed servers
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            servers:
              - 'servers/**'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Validate server structure
        if: steps.filter.outputs.servers == 'true'
        run: |
          for server_dir in servers/*/; do
            if [ -d "$server_dir" ]; then
              for version_dir in "$server_dir"/*/; do
                if [ -d "$version_dir" ]; then
                  echo "Validating $version_dir"
                  
                  # Check index.ts exists
                  if [ ! -f "$version_dir/index.ts" ]; then
                    echo "ERROR: index.ts not found in $version_dir"
                    exit 1
                  fi
                  
                  # Check package.json exists and has required fields
                  if [ ! -f "$version_dir/package.json" ]; then
                    echo "ERROR: package.json not found in $version_dir"
                    exit 1
                  fi
                  
                   cd "$version_dir" && bun install
                   
                   # Generate wrangler.toml and entry for wrangler bundling
                   echo "Bundling with wrangler..."
                   echo 'export { XTRNState } from "@xtrn/server"; export { default } from "./index.ts";' > _cf_entry.ts
                  SLUG=$(basename "$(dirname "$version_dir")")
                  VERSION=$(basename "$version_dir")
                  VERSION_DASHED=$(echo "$VERSION" | tr '.' '-')
                  WORKER_NAME="xtrn-${SLUG}-${VERSION_DASHED}"
                  printf 'name = "%s"\nmain = "_cf_entry.ts"\ncompatibility_date = "2025-09-23"\ncompatibility_flags = ["nodejs_compat"]\n\n[vars]\nOAUTH_CLIENT_ID = ""\nOAUTH_CLIENT_SECRET = ""\nOAUTH_CALLBACK_URL = ""\n\n[[durable_objects.bindings]]\nname = "XTRN_STATE"\nclass_name = "XTRNState"\n\n[[migrations]]\ntag = "v1"\nnew_sqlite_classes = ["XTRNState"]\n' "$WORKER_NAME" > wrangler.toml
                  
                  # Dry-run deploy to validate bundling succeeds
                  bunx wrangler deploy --dry-run --outdir=dist || exit 1
                  rm -f _cf_entry.ts wrangler.toml
                  
                  # Smoke test with Miniflare using wrangler's bundled output
                  echo "Running Miniflare smoke test..."
                  WORKER_FILE=$(ls dist/*.js 2>/dev/null | head -n1)
                  if [ -z "$WORKER_FILE" ]; then
                    echo "ERROR: No bundled worker output found in dist/"
                    exit 1
                  fi
                  bun run --eval "import { Miniflare } from 'miniflare'; import { readFileSync } from 'fs'; const mf = new Miniflare({ modules: true, scriptPath: '${WORKER_FILE}', compatibilityDate: '2025-09-23', compatibilityFlags: ['nodejs_compat'], durableObjects: { XTRN_STATE: 'XTRNState' } }); try { const response = await mf.dispatchFetch('http://localhost/details'); const data = await response.json(); if (!data.name || !data.version) { console.error('ERROR: /details response missing name or version fields'); console.error('Response:', data); process.exit(1); } console.log('Smoke test passed:', data.name, data.version); process.exit(0); } catch (error) { console.error('ERROR: Smoke test failed:', error.message); process.exit(1); } finally { await mf.dispose(); }" || exit 1
                  
                  rm -rf dist
                  cd ../..
                fi
              done
            fi
          done
          
          echo "All validations passed!"