name: Deploy Server to Sprite

on:
  workflow_dispatch:
    inputs:
      slug:
        description: 'Server slug (e.g., google-calendar)'
        required: true
        type: string
      version:
        description: 'Server version (e.g., v2.0.0)'
        required: true
        type: string

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout xtrn-servers
        uses: actions/checkout@v4

      - name: Checkout xtrn-prod (for deploycli + xtrnlib)
        uses: actions/checkout@v4
        with:
          repository: AbhinavPalacharla/xtrn
          token: ${{ secrets.XTRN_REPO_TOKEN }}
          path: xtrn-prod
          ref: race-cond-redesign

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'

      - name: Build xtrnlib (from xtrn-prod)
        run: |
          cd xtrn-prod/backend/xtrnlib
          bun install
          bun run build
          bun link

      - name: Copy server source to xtrn-prod structure
        run: |
          # deploycli expects: xtrnservers/slug/version/
          mkdir -p xtrn-prod/backend/xtrnservers/${{ inputs.slug }}/${{ inputs.version }}
          cp -r servers/${{ inputs.slug }}/${{ inputs.version }}/* \
                xtrn-prod/backend/xtrnservers/${{ inputs.slug }}/${{ inputs.version }}/
          
          # Link xtrnlib in the server directory
          cd xtrn-prod/backend/xtrnservers/${{ inputs.slug }}/${{ inputs.version }}
          bun link xtrn-server
          bun install

      - name: Deploy to Sprite
        id: deploy
        env:
          SPRITE_TOKEN: ${{ secrets.SPRITE_TOKEN }}
        working-directory: xtrn-prod/backend
        run: |
          # Build and run deploycli
          go build -o deploycli ./cmd/deploycli
          
          OUTPUT=$(./deploycli --server=${{ inputs.slug }} --version=${{ inputs.version }} 2>&1) || true
          echo "$OUTPUT"
          
          # Extract URL from DEPLOY_URL= line
          SPRITE_URL=$(echo "$OUTPUT" | grep "^DEPLOY_URL=" | cut -d= -f2)
          
          if [ -z "$SPRITE_URL" ]; then
            echo "::error::Failed to extract DEPLOY_URL from output"
            exit 1
          fi
          
          echo "sprite-url=$SPRITE_URL" >> $GITHUB_OUTPUT
          echo "DEPLOY_URL=$SPRITE_URL"

      - name: Summary
        run: |
          echo "## ðŸš€ Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Field | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Server | \`${{ inputs.slug }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Version | \`${{ inputs.version }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| URL | ${{ steps.deploy.outputs.sprite-url }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Register in local DB" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "cd backend && make sprite-register URL=${{ steps.deploy.outputs.sprite-url }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
