name: Deploy Server to Cloudflare Workers

on:
  workflow_run:
    workflows: ["Validate Server Submission"]
    types:
      - completed
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    outputs:
      worker-url: ${{ steps.output-url.outputs.worker-url }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1

      - name: Detect changed servers
        id: detect
        run: |
          # Get changed files from the triggering workflow
          CHANGED_FILES=$(git diff --name-only ${{ github.event.workflow_run.head_sha }}~1 ${{ github.event.workflow_run.head_sha }})
          
          # Extract slug and version from changed server paths
          SERVER_PATH=$(echo "$CHANGED_FILES" | grep '^servers/' | head -n1)
          
          if [ -z "$SERVER_PATH" ]; then
            echo "No server changes detected"
            exit 1
          fi
          
          SLUG=$(echo "$SERVER_PATH" | cut -d'/' -f2)
          VERSION=$(echo "$SERVER_PATH" | cut -d'/' -f3)
          
          echo "slug=$SLUG" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Detected server: $SLUG $VERSION"

      - name: Install dependencies
        run: |
          cd servers/${{ steps.detect.outputs.slug }}/${{ steps.detect.outputs.version }}
          bun install

      - name: Generate wrangler.toml and deploy entry
        run: |
          cd servers/${{ steps.detect.outputs.slug }}/${{ steps.detect.outputs.version }}
          VERSION_DASHED=$(echo "${{ steps.detect.outputs.version }}" | tr '.' '-')
          WORKER_NAME="xtrn-${{ steps.detect.outputs.slug }}-${VERSION_DASHED}"
          echo 'export { XTRNState } from "@xtrn/server"; export { default } from "./index.ts";' > _cf_entry.ts
          printf 'name = "%s"\nmain = "_cf_entry.ts"\ncompatibility_date = "2025-09-23"\ncompatibility_flags = ["nodejs_compat"]\n\n[vars]\nOAUTH_CLIENT_ID = ""\nOAUTH_CLIENT_SECRET = ""\nOAUTH_CALLBACK_URL = ""\n\n[[durable_objects.bindings]]\nname = "XTRN_STATE"\nclass_name = "XTRNState"\n\n[[migrations]]\ntag = "v1"\nnew_sqlite_classes = ["XTRNState"]\n' "$WORKER_NAME" > wrangler.toml
          echo "Generated wrangler.toml for worker: $WORKER_NAME"
          cat wrangler.toml

      - name: Deploy to Cloudflare Workers
        id: deploy
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          cd servers/${{ steps.detect.outputs.slug }}/${{ steps.detect.outputs.version }}
          DEPLOY_OUTPUT=$(bunx wrangler deploy 2>&1)
          echo "$DEPLOY_OUTPUT"
          WORKER_URL=$(echo "$DEPLOY_OUTPUT" | grep -o 'https://[a-zA-Z0-9._-]*\.workers\.dev')
          echo "worker-url=$WORKER_URL" >> $GITHUB_OUTPUT

      - name: Health check
        id: health
        run: |
          WORKER_URL="${{ steps.deploy.outputs.worker-url }}"
          echo "Checking $WORKER_URL/details"
          
          # Wait a few seconds for deployment to propagate
          sleep 5
          
          # Health check with retry
          MAX_RETRIES=5
          RETRY_COUNT=0
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            if curl -f -s "$WORKER_URL/details" > /dev/null; then
              echo "Health check passed!"
              echo "worker-url=$WORKER_URL" >> $GITHUB_OUTPUT
              exit 0
            fi
            
            RETRY_COUNT=$((RETRY_COUNT + 1))
            echo "Health check attempt $RETRY_COUNT failed, retrying..."
            sleep 3
          done
          
          echo "Health check failed after $MAX_RETRIES attempts"
          exit 1

      - name: Cleanup deploy artifacts
        if: always()
        run: |
          cd servers/${{ steps.detect.outputs.slug }}/${{ steps.detect.outputs.version }}
          rm -f _cf_entry.ts wrangler.toml

      - name: Detect first deploy
        id: first-deploy
        run: |
          if git show HEAD~1:servers/${{ steps.detect.outputs.slug }}/${{ steps.detect.outputs.version }}/index.ts > /dev/null 2>&1; then
            echo "first=false" >> $GITHUB_OUTPUT
          else
            echo "first=true" >> $GITHUB_OUTPUT
          fi

      - name: Checkout xtrn
        uses: actions/checkout@v4
        with:
          repository: AbhinavPalacharla/xtrn
          path: xtrn

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'

      - name: Run migration
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          cd xtrn/backend
          go build -o migratecli ./cmd/migratecli/
          WORKER_URL="${{ steps.deploy.outputs.worker-url }}"
          echo "Migrating ${{ steps.detect.outputs.slug }} ${{ steps.detect.outputs.version }} ($WORKER_URL)"
          ./migratecli --url "$WORKER_URL" \
            --oauth-client-id "${{ secrets.OAUTH_CLIENT_ID }}" \
            --oauth-client-secret "${{ secrets.OAUTH_CLIENT_SECRET }}" \
            --oauth-callback-url "${{ secrets.OAUTH_CALLBACK_URL }}" \
            ${{ steps.first-deploy.outputs.first == 'true' && '--first-deploy' || '' }}

      - name: Output Worker URL
        run: |
          echo "Deployed to: ${{ steps.deploy.outputs.worker-url }}"
          echo "Server: ${{ steps.detect.outputs.slug }} ${{ steps.detect.outputs.version }}"
          echo "First deploy: ${{ steps.first-deploy.outputs.first }}"
