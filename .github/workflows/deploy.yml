name: Deploy Server to Cloudflare Workers

on:
  workflow_run:
    workflows: ["Validate Server Submission"]
    types:
      - completed

permissions:
  deployments: write
  contents: read
  pull-requests: read
  actions: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    outputs:
      worker-url: ${{ steps.output-url.outputs.worker-url }}
    steps:
      - name: Find PR number from head SHA
        id: find-pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          HEAD_SHA="${{ github.event.workflow_run.head_sha }}"
          # Search for open PRs with this head SHA
          PR_NUMBER=$(gh api repos/${{ github.repository }}/pulls?state=open\&per_page=100 \
            --jq ".[] | select(.head.sha == \"$HEAD_SHA\") | .number" | head -1)
          
          if [ -z "$PR_NUMBER" ]; then
            echo "No open PR found for SHA $HEAD_SHA â€” skipping deploy"
            echo "found=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "Found PR #$PR_NUMBER for SHA $HEAD_SHA"
          echo "found=true" >> $GITHUB_OUTPUT
          echo "number=$PR_NUMBER" >> $GITHUB_OUTPUT

      - uses: actions/checkout@v4
        if: steps.find-pr.outputs.found == 'true'
        with:
          fetch-depth: 0
          ref: ${{ github.event.workflow_run.head_sha }}

      - name: Setup Node.js
        if: steps.find-pr.outputs.found == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup Bun
        if: steps.find-pr.outputs.found == 'true'
        uses: oven-sh/setup-bun@v1

      - name: Download thread metadata
        if: steps.find-pr.outputs.found == 'true'
        uses: actions/download-artifact@v4
        with:
          name: thread-metadata-${{ steps.find-pr.outputs.number }}
          path: /tmp/thread-metadata
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true

      - name: Read thread metadata
        if: steps.find-pr.outputs.found == 'true'
        id: thread
        run: |
          if [ -f /tmp/thread-metadata/thread-metadata.json ]; then
            THREAD_TS=$(jq -r '.thread_ts' /tmp/thread-metadata/thread-metadata.json)
            echo "thread_ts=$THREAD_TS" >> $GITHUB_OUTPUT
          else
            echo "thread_ts=" >> $GITHUB_OUTPUT
          fi

      - name: Detect changed servers
        if: steps.find-pr.outputs.found == 'true'
        id: detect
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER=${{ steps.find-pr.outputs.number }}
          CHANGED_FILES=$(gh api repos/${{ github.repository }}/pulls/$PR_NUMBER/files --jq '.[].filename')
          
          # Extract slug and version from changed server paths
          SERVER_PATH=$(echo "$CHANGED_FILES" | grep '^servers/' | head -n1)
          
          if [ -z "$SERVER_PATH" ]; then
            echo "No server changes detected"
            exit 1
          fi
          
          SLUG=$(echo "$SERVER_PATH" | cut -d'/' -f2)
          VERSION=$(echo "$SERVER_PATH" | cut -d'/' -f3)
          
          echo "slug=$SLUG" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Detected server: $SLUG $VERSION"

      - name: Install dependencies
        if: steps.find-pr.outputs.found == 'true'
        run: |
          cd servers/${{ steps.detect.outputs.slug }}/${{ steps.detect.outputs.version }}
          bun install

      - name: Generate wrangler.toml and deploy entry
        if: steps.find-pr.outputs.found == 'true'
        run: |
          cd servers/${{ steps.detect.outputs.slug }}/${{ steps.detect.outputs.version }}
          VERSION_DASHED=$(echo "${{ steps.detect.outputs.version }}" | tr '.' '-')
          WORKER_NAME="xtrn-${{ steps.detect.outputs.slug }}-${VERSION_DASHED}"
          echo 'export { XTRNState } from "@xtrn/server"; export { default } from "./index.ts";' > _cf_entry.ts
          printf 'name = "%s"\nmain = "_cf_entry.ts"\ncompatibility_date = "2025-09-23"\ncompatibility_flags = ["nodejs_compat"]\n\n[vars]\nOAUTH_CLIENT_ID = ""\nOAUTH_CLIENT_SECRET = ""\nOAUTH_CALLBACK_URL = ""\n\n[[durable_objects.bindings]]\nname = "XTRN_STATE"\nclass_name = "XTRNState"\n\n[[migrations]]\ntag = "v1"\nnew_sqlite_classes = ["XTRNState"]\n' "$WORKER_NAME" > wrangler.toml
          echo "Generated wrangler.toml for worker: $WORKER_NAME"
          cat wrangler.toml

      - name: Deploy to Cloudflare Workers
        if: steps.find-pr.outputs.found == 'true'
        id: deploy
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          cd servers/${{ steps.detect.outputs.slug }}/${{ steps.detect.outputs.version }}
          DEPLOY_OUTPUT=$(bunx wrangler deploy 2>&1)
          echo "$DEPLOY_OUTPUT"
          WORKER_URL=$(echo "$DEPLOY_OUTPUT" | grep -o 'https://[a-zA-Z0-9._-]*\.workers\.dev')
          echo "worker-url=$WORKER_URL" >> $GITHUB_OUTPUT

      - name: Health check
        if: steps.find-pr.outputs.found == 'true'
        id: health
        run: |
          WORKER_URL="${{ steps.deploy.outputs.worker-url }}"
          echo "Checking $WORKER_URL/details"
          
          # Wait a few seconds for deployment to propagate
          sleep 5
          
          # Health check with retry
          MAX_RETRIES=5
          RETRY_COUNT=0
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            if curl -f -s "$WORKER_URL/details" > /dev/null; then
              echo "Health check passed!"
              echo "worker-url=$WORKER_URL" >> $GITHUB_OUTPUT
              exit 0
            fi
            
            RETRY_COUNT=$((RETRY_COUNT + 1))
            echo "Health check attempt $RETRY_COUNT failed, retrying..."
            sleep 3
          done
          
          echo "Health check failed after $MAX_RETRIES attempts"
          exit 1

      - name: Cleanup deploy artifacts
        if: always() && steps.find-pr.outputs.found == 'true'
        run: |
          cd servers/${{ steps.detect.outputs.slug }}/${{ steps.detect.outputs.version }}
          rm -f _cf_entry.ts wrangler.toml

      - name: Detect first deploy and fetch details
        if: steps.find-pr.outputs.found == 'true'
        id: deploy-info
        run: |
          SLUG="${{ steps.detect.outputs.slug }}"
          VERSION="${{ steps.detect.outputs.version }}"
          WORKER_URL="${{ steps.deploy.outputs.worker-url }}"
          
          # Check if other versions exist for this slug
          VERSION_COUNT=$(find servers/$SLUG -maxdepth 1 -type d | grep -v "^servers/$SLUG$" | wc -l)
          if [ "$VERSION_COUNT" -le 1 ]; then
            FIRST_DEPLOY="true"
            echo "first-deploy=true" >> $GITHUB_OUTPUT
          else
            FIRST_DEPLOY="false"
            echo "first-deploy=false" >> $GITHUB_OUTPUT
            # Find previous version (not current one)
            OLD_VERSION=$(find servers/$SLUG -maxdepth 1 -type d -name "v*" | grep -v "$VERSION" | sort -V | tail -n1 | xargs basename)
            echo "old-version=$OLD_VERSION" >> $GITHUB_OUTPUT
          fi
          
          # Fetch /details from deployed Worker
          DETAILS=$(curl -s "$WORKER_URL/details")
          
          # Extract fields using jq
          NAME=$(echo "$DETAILS" | jq -r '.name')
          TOOLS_COUNT=$(echo "$DETAILS" | jq -r '.tools | length')
          HAS_OAUTH=$(echo "$DETAILS" | jq -r 'if .oauth then "true" else "false" end')
          OAUTH_PROVIDER=$(echo "$DETAILS" | jq -r '.oauth.provider // "None"')
          REQUIRED_ENV_COUNT=$(echo "$DETAILS" | jq -r '.requiredEnv | length')
          HAS_REQUIRED_ENV=$(echo "$DETAILS" | jq -r 'if (.requiredEnv | length) > 0 then "true" else "false" end')
          
          echo "name=$NAME" >> $GITHUB_OUTPUT
          echo "tools-count=$TOOLS_COUNT" >> $GITHUB_OUTPUT
          echo "has-oauth=$HAS_OAUTH" >> $GITHUB_OUTPUT
          echo "oauth-provider=$OAUTH_PROVIDER" >> $GITHUB_OUTPUT
          echo "required-env-count=$REQUIRED_ENV_COUNT" >> $GITHUB_OUTPUT
          echo "has-required-env=$HAS_REQUIRED_ENV" >> $GITHUB_OUTPUT
           
          echo "Deployed: $NAME v$VERSION"
          echo "Tools: $TOOLS_COUNT"
          echo "OAuth: $OAUTH_PROVIDER"
          echo "Required env: $REQUIRED_ENV_COUNT"
          echo "First deploy: $FIRST_DEPLOY"

      - name: Create GitHub Deployment
        if: steps.find-pr.outputs.found == 'true'
        id: deployment
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          SLUG="${{ steps.detect.outputs.slug }}"
          VERSION="${{ steps.detect.outputs.version }}"
          WORKER_URL="${{ steps.deploy.outputs.worker-url }}"
          NAME="${{ steps.deploy-info.outputs.name }}"
          TOOLS_COUNT="${{ steps.deploy-info.outputs.tools-count }}"
          HAS_OAUTH="${{ steps.deploy-info.outputs.has-oauth }}"
          OAUTH_PROVIDER="${{ steps.deploy-info.outputs.oauth-provider }}"
          REQUIRED_ENV_COUNT="${{ steps.deploy-info.outputs.required-env-count }}"
          HAS_REQUIRED_ENV="${{ steps.deploy-info.outputs.has-required-env }}"
          FIRST_DEPLOY="${{ steps.deploy-info.outputs.first-deploy }}"
          PR_NUMBER=${{ steps.find-pr.outputs.number }}
          THREAD_TS="${{ steps.thread.outputs.thread_ts }}"
          
          # Create deployment payload with all metadata
          PAYLOAD=$(cat <<EOF
          {
            "ref": "${{ github.event.workflow_run.head_sha }}",
            "environment": "cloudflare-workers",
            "description": "Deploy $NAME $VERSION to Cloudflare Workers",
            "auto_merge": false,
            "required_contexts": [],
            "payload": {
              "pr_number": "$PR_NUMBER",
              "slug": "$SLUG",
              "version": "$VERSION",
              "worker_url": "$WORKER_URL",
              "oauth_required": $HAS_OAUTH,
              "first_deploy": $FIRST_DEPLOY,
              "name": "$NAME",
              "tools_count": "$TOOLS_COUNT",
              "oauth_provider": "$OAUTH_PROVIDER",
              "has_required_env": "$HAS_REQUIRED_ENV",
              "required_env_count": "$REQUIRED_ENV_COUNT",
              "thread_ts": "$THREAD_TS"
            }
          }
          EOF
          )
          
          # Create deployment
          DEPLOY_RESPONSE=$(gh api repos/${{ github.repository }}/deployments -H "Accept: application/vnd.github.v3+json" --input - <<< "$PAYLOAD")
          DEPLOY_ID=$(echo "$DEPLOY_RESPONSE" | jq -r '.id')
          
          echo "deployment-id=$DEPLOY_ID" >> $GITHUB_OUTPUT
          echo "Created deployment: $DEPLOY_ID"

      - name: Create deployment status
        if: steps.find-pr.outputs.found == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          DEPLOY_ID="${{ steps.deployment.outputs.deployment-id }}"
          WORKER_URL="${{ steps.deploy.outputs.worker-url }}"
          
          # Create success status
          gh api repos/${{ github.repository }}/deployments/$DEPLOY_ID/statuses \
            -H "Accept: application/vnd.github.v3+json" \
            -f state=success \
            -f description="Deployment successful"
          
          echo "Created deployment status for $DEPLOY_ID"
