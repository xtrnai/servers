name: Deploy Server to Cloudflare Workers

on:
  workflow_run:
    workflows: ["Validate Server Submission"]
    types:
      - completed
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    outputs:
      worker-url: ${{ steps.output-url.outputs.worker-url }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1

      - name: Detect changed servers
        id: detect
        run: |
          # Get changed files from the triggering workflow
          CHANGED_FILES=$(git diff --name-only ${{ github.event.workflow_run.head_sha }}~1 ${{ github.event.workflow_run.head_sha }})
          
          # Extract slug and version from changed server paths
          SERVER_PATH=$(echo "$CHANGED_FILES" | grep '^servers/' | head -n1)
          
          if [ -z "$SERVER_PATH" ]; then
            echo "No server changes detected"
            exit 1
          fi
          
          SLUG=$(echo "$SERVER_PATH" | cut -d'/' -f2)
          VERSION=$(echo "$SERVER_PATH" | cut -d'/' -f3)
          
          echo "slug=$SLUG" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Detected server: $SLUG $VERSION"

      - name: Install dependencies
        run: |
          cd servers/${{ steps.detect.outputs.slug }}/${{ steps.detect.outputs.version }}
          bun install

      - name: Generate wrangler.toml and deploy entry
        run: |
          cd servers/${{ steps.detect.outputs.slug }}/${{ steps.detect.outputs.version }}
          VERSION_DASHED=$(echo "${{ steps.detect.outputs.version }}" | tr '.' '-')
          WORKER_NAME="xtrn-${{ steps.detect.outputs.slug }}-${VERSION_DASHED}"
          echo 'export { XTRNState } from "@xtrn/server"; export { default } from "./index.ts";' > _cf_entry.ts
          printf 'name = "%s"\nmain = "_cf_entry.ts"\ncompatibility_date = "2025-09-23"\ncompatibility_flags = ["nodejs_compat"]\n\n[vars]\nOAUTH_CLIENT_ID = ""\nOAUTH_CLIENT_SECRET = ""\nOAUTH_CALLBACK_URL = ""\n\n[[durable_objects.bindings]]\nname = "XTRN_STATE"\nclass_name = "XTRNState"\n\n[[migrations]]\ntag = "v1"\nnew_sqlite_classes = ["XTRNState"]\n' "$WORKER_NAME" > wrangler.toml
          echo "Generated wrangler.toml for worker: $WORKER_NAME"
          cat wrangler.toml

      - name: Deploy to Cloudflare Workers
        id: deploy
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          cd servers/${{ steps.detect.outputs.slug }}/${{ steps.detect.outputs.version }}
          DEPLOY_OUTPUT=$(bunx wrangler deploy 2>&1)
          echo "$DEPLOY_OUTPUT"
          WORKER_URL=$(echo "$DEPLOY_OUTPUT" | grep -o 'https://[a-zA-Z0-9._-]*\.workers\.dev')
          echo "worker-url=$WORKER_URL" >> $GITHUB_OUTPUT

      - name: Health check
        id: health
        run: |
          WORKER_URL="${{ steps.deploy.outputs.worker-url }}"
          echo "Checking $WORKER_URL/details"
          
          # Wait a few seconds for deployment to propagate
          sleep 5
          
          # Health check with retry
          MAX_RETRIES=5
          RETRY_COUNT=0
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            if curl -f -s "$WORKER_URL/details" > /dev/null; then
              echo "Health check passed!"
              echo "worker-url=$WORKER_URL" >> $GITHUB_OUTPUT
              exit 0
            fi
            
            RETRY_COUNT=$((RETRY_COUNT + 1))
            echo "Health check attempt $RETRY_COUNT failed, retrying..."
            sleep 3
          done
          
          echo "Health check failed after $MAX_RETRIES attempts"
          exit 1

      - name: Cleanup deploy artifacts
        if: always()
        run: |
          cd servers/${{ steps.detect.outputs.slug }}/${{ steps.detect.outputs.version }}
          rm -f _cf_entry.ts wrangler.toml

      - name: Detect first deploy and fetch details
        id: deploy-info
        run: |
          SLUG="${{ steps.detect.outputs.slug }}"
          VERSION="${{ steps.detect.outputs.version }}"
          WORKER_URL="${{ steps.deploy.outputs.worker-url }}"
          
          # Check if other versions exist for this slug
          VERSION_COUNT=$(find servers/$SLUG -maxdepth 1 -type d | grep -v "^servers/$SLUG$" | wc -l)
          if [ "$VERSION_COUNT" -le 1 ]; then
            FIRST_DEPLOY="true"
            echo "first-deploy=true" >> $GITHUB_OUTPUT
          else
            FIRST_DEPLOY="false"
            echo "first-deploy=false" >> $GITHUB_OUTPUT
            # Find previous version (not current one)
            OLD_VERSION=$(find servers/$SLUG -maxdepth 1 -type d -name "v*" | grep -v "$VERSION" | sort -V | tail -n1 | xargs basename)
            echo "old-version=$OLD_VERSION" >> $GITHUB_OUTPUT
          fi
          
          # Fetch /details from deployed Worker
          DETAILS=$(curl -s "$WORKER_URL/details")
          
          # Extract fields using jq
          NAME=$(echo "$DETAILS" | jq -r '.name')
          TOOLS_COUNT=$(echo "$DETAILS" | jq -r '.tools | length')
          HAS_OAUTH=$(echo "$DETAILS" | jq -r 'if .oauthConfig then "true" else "false" end')
          OAUTH_PROVIDER=$(echo "$DETAILS" | jq -r '.oauthConfig.provider // "None"')
          
          echo "name=$NAME" >> $GITHUB_OUTPUT
          echo "tools-count=$TOOLS_COUNT" >> $GITHUB_OUTPUT
          echo "has-oauth=$HAS_OAUTH" >> $GITHUB_OUTPUT
          echo "oauth-provider=$OAUTH_PROVIDER" >> $GITHUB_OUTPUT
          
          echo "Deployed: $NAME v$VERSION"
          echo "Tools: $TOOLS_COUNT"
          echo "OAuth: $OAUTH_PROVIDER"
          echo "First deploy: $FIRST_DEPLOY"

      - name: Post PR comment
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const slug = '${{ steps.detect.outputs.slug }}';
            const version = '${{ steps.detect.outputs.version }}';
            const workerUrl = '${{ steps.deploy.outputs.worker-url }}';
            const name = '${{ steps.deploy-info.outputs.name }}';
            const toolsCount = '${{ steps.deploy-info.outputs.tools-count }}';
            const hasOauth = '${{ steps.deploy-info.outputs.has-oauth }}' === 'true';
            const oauthProvider = '${{ steps.deploy-info.outputs.oauth-provider }}';
            const firstDeploy = '${{ steps.deploy-info.outputs.first-deploy }}' === 'true';
            const oldVersion = '${{ steps.deploy-info.outputs.old-version }}' || '';
            
            const oauthLine = hasOauth 
              ? '**OAuth**: ' + oauthProvider + ' (credentials needed)'
              : '**OAuth**: None';
            
            const deployType = firstDeploy 
              ? '**Type**: First deploy'
              : '**Type**: Migration from ' + oldVersion;
            
            const oauthInstructions = hasOauth
              ? '\n\nFor OAuth servers:\n```\n/approve oauth_client_id=YOUR_ID oauth_client_secret=YOUR_SECRET oauth_callback_url=YOUR_URL\n```'
              : '';
            
            const jsonData = JSON.stringify({
              slug: slug,
              version: version,
              worker_url: workerUrl,
              has_oauth: hasOauth,
              first_deploy: firstDeploy
            });
            
            const commentLines = [
              'ðŸš€ **Deployed** `' + name + '` ' + version + ' to Cloudflare Workers',
              '',
              '**URL**: ' + workerUrl,
              '**Tools**: ' + toolsCount,
              oauthLine,
              deployType,
              '',
              'To approve, comment:',
              '```',
              '/approve',
              '```' + oauthInstructions,
              '',
              'To reject and tear down:',
              '```',
              '/reject',
              '```',
              '',
              '<!-- XTRN_DEPLOY:' + jsonData + ' -->'
            ];
            
            const comment = commentLines.join('\n');
            
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'all',
              sort: 'updated',
              direction: 'desc'
            });
            
            const pr = prs.find(pr => pr.merge_commit_sha === '${{ github.event.workflow_run.head_sha }}');
            
            if (pr) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                body: comment
              });
              console.log('Posted comment to PR #' + pr.number);
            } else {
              console.log('No PR found for this commit');
              console.log(comment);
            }
