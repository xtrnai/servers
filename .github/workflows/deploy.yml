name: Deploy Server to Sprite

on:
  workflow_dispatch:
    inputs:
      slug:
        description: 'Server slug (e.g., google-calendar)'
        required: true
        type: string
      version:
        description: 'Server version (e.g., v2.0.0)'
        required: true
        type: string
      oauth_client_id:
        description: 'OAuth Client ID (optional)'
        required: false
        type: string
      oauth_client_secret:
        description: 'OAuth Client Secret (optional)'
        required: false
        type: string
      oauth_callback_url:
        description: 'OAuth Callback URL (optional)'
        required: false
        type: string

jobs:
  deploy:
    runs-on: ubuntu-latest
    outputs:
      sprite-url: ${{ steps.deploy.outputs.sprite-url }}
    steps:
      - name: Checkout xtrn-servers
        uses: actions/checkout@v4
        with:
          path: xtrn-servers

      - name: Checkout xtrn-prod (for deploycli)
        uses: actions/checkout@v4
        with:
          repository: AbhinavPalacharla/xtrn
          ref: race-cond-redesign
          path: xtrn-prod
          token: ${{ secrets.XTRN_REPO_TOKEN }}

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'

      - name: Setup jq
        uses: dcarbone/install-jq-action@v2

      - name: Build and link xtrnlib
        run: |
          cd xtrn-servers/xtrnlib
          bun install
          bun run build
          bun link

      - name: Install server dependencies
        run: |
          cd xtrn-servers/servers/${{ inputs.slug }}/${{ inputs.version }}
          bun link xtrn-server
          bun install

      - name: Inject OAuth credentials
        if: inputs.oauth_client_id != ''
        run: |
          cd xtrn-servers/servers/${{ inputs.slug }}/${{ inputs.version }}
          jq --arg cid "${{ inputs.oauth_client_id }}" \
             --arg cs "${{ inputs.oauth_client_secret }}" \
             --arg cb "${{ inputs.oauth_callback_url }}" \
             '.client_id=$cid | .client_secret=$cs | .callback_url=$cb' \
             oauth.json > tmp.json && mv tmp.json oauth.json

      - name: Setup deploycli directory structure
        run: |
          # deploycli expects servers in xtrnservers/slug/version
          mkdir -p xtrn-prod/backend/xtrnservers/${{ inputs.slug }}
          cp -r xtrn-servers/servers/${{ inputs.slug }}/${{ inputs.version }} \
                xtrn-prod/backend/xtrnservers/${{ inputs.slug }}/${{ inputs.version }}

      - name: Build deploycli
        run: |
          cd xtrn-prod/backend
          go build -o deploycli ./cmd/deploycli/

      - name: Deploy to Sprite
        id: deploy
        env:
          SPRITE_TOKEN: ${{ secrets.SPRITE_TOKEN }}
        run: |
          cd xtrn-prod/backend
          OUTPUT=$(./deploycli --server=${{ inputs.slug }} --version=${{ inputs.version }} 2>&1 | tee /dev/stderr | tail -n 20)
          URL=$(echo "$OUTPUT" | grep -o '"url": "[^"]*"' | sed 's/"url": "//;s/"$//' | head -1)
          if [ -z "$URL" ]; then
            echo "Failed to extract URL from deploycli output"
            exit 1
          fi
          echo "sprite-url=$URL" >> $GITHUB_OUTPUT
          echo "Deployed to: $URL"

      - name: Health check
        run: |
          SPRITE_URL="${{ steps.deploy.outputs.sprite-url }}"
          echo "Checking $SPRITE_URL/details"
          for i in {1..30}; do
            if curl -sf "$SPRITE_URL/details" > /dev/null; then
              echo "Health check passed (attempt $i/30)"
              curl -s "$SPRITE_URL/details" | jq .
              exit 0
            fi
            echo "Attempt $i/30 failed, retrying in 2s..."
            sleep 2
          done
          echo "Health check failed after 30 attempts"
          exit 1
