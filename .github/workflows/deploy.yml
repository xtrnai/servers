name: Deploy Server to Cloudflare Workers

on:
  workflow_run:
    workflows: ["Validate Server Submission"]
    types:
      - completed
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    outputs:
      worker-url: ${{ steps.output-url.outputs.worker-url }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1

      - name: Detect changed servers
        id: detect
        run: |
          # Get changed files from the triggering workflow
          CHANGED_FILES=$(git diff --name-only ${{ github.event.workflow_run.head_sha }}~1 ${{ github.event.workflow_run.head_sha }})
          
          # Extract slug and version from changed server paths
          SERVER_PATH=$(echo "$CHANGED_FILES" | grep '^servers/' | head -n1)
          
          if [ -z "$SERVER_PATH" ]; then
            echo "No server changes detected"
            exit 1
          fi
          
          SLUG=$(echo "$SERVER_PATH" | cut -d'/' -f2)
          VERSION=$(echo "$SERVER_PATH" | cut -d'/' -f3)
          
          echo "slug=$SLUG" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Detected server: $SLUG $VERSION"

      - name: Build and link xtrnlib
        run: |
          cd xtrnlib
          bun install
          bun run build
          bun link
          cd ..

      - name: Install dependencies
        run: |
          cd servers/${{ steps.detect.outputs.slug }}/${{ steps.detect.outputs.version }}
          bun install
          bun link xtrn-server

      - name: Bundle with esbuild
        run: |
          cd servers/${{ steps.detect.outputs.slug }}/${{ steps.detect.outputs.version }}
          echo 'export { XTRNState } from "xtrn-server"; export { default } from "./index.ts";' > _cf_entry.ts
          npx esbuild _cf_entry.ts \
            --bundle \
            --format=esm \
            --platform=neutral \
            --target=es2020 \
            --outfile=worker.js \
            --external:cloudflare:workers \
            --external:assert --external:buffer --external:child_process --external:crypto \
            --external:events --external:fs --external:http --external:http2 --external:https \
            --external:net --external:os --external:path --external:process --external:querystring \
            --external:stream --external:tls --external:tty --external:url --external:util --external:zlib \
            --external:node:assert --external:node:buffer --external:node:child_process --external:node:crypto \
            --external:node:events --external:node:fs --external:node:http --external:node:http2 --external:node:https \
            --external:node:net --external:node:os --external:node:path --external:node:process --external:node:querystring \
            --external:node:stream --external:node:tls --external:node:tty --external:node:url --external:node:util --external:node:zlib
          rm -f _cf_entry.ts

      - name: Generate wrangler.toml
        run: |
          cd servers/${{ steps.detect.outputs.slug }}/${{ steps.detect.outputs.version }}
          VERSION_DASHED=$(echo "${{ steps.detect.outputs.version }}" | tr '.' '-')
          WORKER_NAME="xtrn-${{ steps.detect.outputs.slug }}-${VERSION_DASHED}"
          printf 'name = "%s"\nmain = "worker.js"\ncompatibility_date = "2025-01-01"\ncompatibility_flags = ["nodejs_compat"]\n\n[vars]\nOAUTH_CLIENT_ID = ""\nOAUTH_CLIENT_SECRET = ""\nOAUTH_CALLBACK_URL = ""\n\n[[durable_objects.bindings]]\nname = "XTRN_STATE"\nclass_name = "XTRNState"\n\n[[migrations]]\ntag = "v1"\nnew_sqlite_classes = ["XTRNState"]\n' "$WORKER_NAME" > wrangler.toml
          echo "Generated wrangler.toml for worker: $WORKER_NAME"
          cat wrangler.toml

      - name: Deploy to Cloudflare Workers
        id: deploy
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          cd servers/${{ steps.detect.outputs.slug }}/${{ steps.detect.outputs.version }}
          npx wrangler deploy --config wrangler.toml

      - name: Health check
        id: health
        run: |
          cd servers/${{ steps.detect.outputs.slug }}/${{ steps.detect.outputs.version }}
          
          # Extract worker name from wrangler.toml
          WORKER_NAME=$(grep '^name = ' wrangler.toml | cut -d'"' -f2)
          WORKER_URL="https://${WORKER_NAME}.workers.dev"
          
          echo "Checking $WORKER_URL/details"
          
          # Wait a few seconds for deployment to propagate
          sleep 5
          
          # Health check with retry
          MAX_RETRIES=5
          RETRY_COUNT=0
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            if curl -f -s "$WORKER_URL/details" > /dev/null; then
              echo "Health check passed!"
              echo "worker-url=$WORKER_URL" >> $GITHUB_OUTPUT
              exit 0
            fi
            
            RETRY_COUNT=$((RETRY_COUNT + 1))
            echo "Health check attempt $RETRY_COUNT failed, retrying..."
            sleep 3
          done
          
          echo "Health check failed after $MAX_RETRIES attempts"
          exit 1

      - name: Output Worker URL
        id: output-url
        run: |
          WORKER_URL="${{ steps.health.outputs.worker-url }}"
          echo "worker-url=$WORKER_URL" >> $GITHUB_OUTPUT
          echo "âœ… Deployed to: $WORKER_URL"
          echo "ðŸ“‹ Server: ${{ steps.detect.outputs.slug }} ${{ steps.detect.outputs.version }}"
